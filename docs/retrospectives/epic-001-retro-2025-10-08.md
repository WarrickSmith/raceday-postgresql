# Epic 001 Retrospective – 2025-10-08

## Context Snapshot
- Epic: 001 – Core Infrastructure Setup
- Stories completed: 10 / 10 (100%)
- Regression testing: Completed (full suite green)
- Deployment status: Pending production cutover
- Stakeholder sign-off: Received

## Delivery Metrics
- Story throughput: 10 closed in week-one infrastructure sprint
- Velocity tracking: Not captured (future epics should size/track points)
- Blockers encountered: None recorded in Dev Agent Records
- Technical debt carried: 1 minor lint cleanup in `server/src/shared/env.ts`

## Quality & Technical Observations
- Zod-based environment validation enforces configuration safety with 14 dedicated tests.
- Partitioned time-series tables plus automation utilities position the database for high-volume ingest.
- Developer onboarding guide expanded to 766 lines covering setup, commands, and troubleshooting.
- Logger foundation (Pino) aligned with architecture and feeds Epic 2 telemetry requirements.

## What Went Well
1. **Database foundations**: Migrations, partitioning, and pg-agent enablement delivered with comprehensive automated tests.
2. **Operational readiness**: Health checks, structured logging, and connection pooling patterns established for downstream stories.
3. **Enablement**: Updated developer onboarding documentation accelerates new contributor ramp-up.

## What Could Improve
1. **Tooling stability**: Vitest worker exit impacting logger tests needs investigation before the data pipeline suite grows.
2. **Lint hygiene**: Inline `eslint-disable` directives in `env.ts` should be consolidated to reduce noise.
3. **Deployment cadence**: Production deployment remains outstanding—must be scheduled ahead of Epic 2.

## Lessons Learned
- Wrap critical migration commands with helper modules (Story 1.2 CLI refactor) to improve safety and reuse.
- Prefer `pg-format` for identifier sanitisation—prevented a SQL injection vector flagged during review.
- Centralising logging via validated env simplified adoption across stories and avoids drift.

## Action Items
| # | Item | Owner | Target |
|---|------|-------|--------|
| 1 | Standardise Vitest executor stability checks in CI | Developer Lead | 2025-10-10 |
| 2 | Pre-flight verification of NZ TAB credentials before each pipeline sprint | Scrum Master | 2025-10-11 |
| 3 | Confirm availability of cross-functional agent roster for ceremonies | Product Manager | 2025-10-09 |
| 4 | Consolidate `eslint-disable` comments in `server/src/shared/env.ts` | Developer Lead | 2025-10-10 |
| 5 | Create Epic 002 PRD entry / pointer in `docs/` | Product Owner | 2025-10-12 |

## Critical Path Before Epic 002
1. Deploy Epic 001 artefacts to production environment and validate.
2. Complete `env.ts` lint cleanup and rerun full regression to confirm no regressions.
3. Capture NZ TAB sample payloads and rate-limit notes; share with data pipeline team.

## Preparation Sprint Checklist
- Scaffold Axios client/retry module and worker-pool baseline (1 day each).
- Document Epic 2 data flow assumptions for onboarding (0.5 day).
- Schedule knowledge spike on NZ TAB API behaviour (0.5 day).

## Next Steps
- Track action items in upcoming stand-ups until closed.
- Trigger production deployment readiness review once lint cleanup and regression rerun complete.
- Kick off Epic 002 planning with updated PRD and validated dependencies.

## Action Item Outcomes – 2025-10-08
- ✅ Action 2: Created the NZ TAB credential pre-flight runbook (`docs/runbooks/nztab-credential-preflight.md`) defining vault checks, Portainer env validation, and smoke-test curl command to certify credentials two business days before each pipeline sprint.
- ✅ Action 1: Added a dedicated Vitest stability runner (`server/scripts/run-vitest-stability-check.mjs`) invoked via `npm run test:stability` and wired into `.github/workflows/ci.yml` so CI runs two deterministic executor passes with `VITEST_SEGFAULT_RETRY` disabled.
- ✅ Action 4: Renamed the environment schema to `envSchema` and replaced scattered `eslint-disable` annotations with a single scoped block in `server/src/shared/env.ts`, keeping lint output clean.
- Verification: `npm run test:stability` and `npm run lint` (server) complete without errors.
